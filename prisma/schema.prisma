datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("DATABASE_URL_SHADOW")
  directUrl         = env("DATABASE_URL_NON_POOLING")
}

generator client {
  provider = "prisma-client-js"
}

enum UserRole {
  USER
  ADMIN
}

model User {
  id                 String    @id @default(cuid())
  name               String?
  email              String    @unique
  emailVerified      DateTime?
  image              String?
  password           String?
  isTwoFactorEnabled Boolean   @default(false)
  billing_address    Json      @default("{}")
  payment_method     Json      @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  role                  UserRole               @default(USER)
  accounts              Account[]
  sessions              Session[]
  sites                 Site[]
  subscriptions         Subscription[]
  Authenticator         Authenticator[]
  links                 Link[]
  customer              Customer?
  twoFactorConfirmation TwoFactorConfirmation?

  feedback   Feedback[]
  likes      Like[]
  affiliates User[]     @relation("Affiliation")
  referer    User?      @relation("Affiliation", fields: [refererId], references: [id])
  refererId  String?

  events         Event[]         @relation("UserEvents")
  workflowStates WorkflowState[]
  executions     Execution[]     @relation("UserActionLogs")
  jobs           Queue[]         @relation("UserQueueJobs")
  outbox         Outbox[]

  @@index([email])
  @@index([role])
  @@index([refererId])
  @@index([id])
  @@index([emailVerified])
}

model Feedback {
  id String @id @default(cuid())

  message String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String?

  @@index([userId])
  @@index([id])
}

model TwoFactorConfirmation {
  id String @id @default(cuid())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  @@unique([userId])
}

model Customer {
  stripe_customer_id String @unique

  user User   @relation(fields: [id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  id   String @unique
}

model Product {
  id          String  @id
  active      Boolean
  name        String
  description String
  image       String
  metadata    Json    @default("{}")

  prices Price[]
}

enum PricingType {
  one_time
  recurring
}

enum PricingPlanInterval {
  day
  week
  month
  year
}

model Price {
  id                String               @id
  active            Boolean
  description       String
  unit_amount       Int?
  currency          String
  type              PricingType
  interval          PricingPlanInterval?
  interval_count    Int?
  trial_period_days Int?
  metadata          Json                 @default("{}")

  subscriptions Subscription[]
  product       Product        @relation(fields: [productId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  productId     String

  @@index([productId])
}

enum SubscriptionStatus {
  trialing
  active
  canceled
  incomplete
  incomplete_expired
  past_due
  unpaid
  paused
}

model Subscription {
  id String @id

  status               SubscriptionStatus
  metadata             Json               @default("{}")
  quantity             Int
  cancel_at_period_end Boolean
  created              DateTime           @default(now())
  current_period_start DateTime           @default(now())
  current_period_end   DateTime           @default(now())
  ended_at             DateTime?
  cancel_at            DateTime?
  canceled_at          DateTime?
  trial_start          DateTime?
  trial_end            DateTime?

  price   Price  @relation(fields: [priceId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  priceId String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  userId  String

  @@index([userId, status])
  @@index([status])
  @@index([userId])
  @@index([current_period_end])
  @@index([priceId])
  @@index([trial_end])
}

model Account {
  id String @id @default(cuid())

  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id String @id @default(cuid())

  sessionToken String   @unique
  expires      DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  @@index([userId])
}

model VerificationToken {
  id String @id @default(cuid())

  identifier String?
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Authenticator {
  id String @id @default(cuid())

  credentialID         String  @unique
  providerAccountId    String
  credentialPublicKey  String
  counter              Int
  credentialDeviceType String
  credentialBackedUp   Boolean
  transports           String?

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String

  @@unique([userId, credentialID])
}

model PasswordResetToken {
  id String @id @default(cuid())

  email   String
  token   String   @unique
  expires DateTime

  @@unique([email, token])
}

model TwoFactorToken {
  id String @id @default(cuid())

  email   String
  token   String   @unique
  expires DateTime

  @@unique([email, token])
}

model Click {
  id String @id @default(cuid())

  part String?

  createdAt DateTime @default(now())

  block   Block?  @relation(fields: [blockId], references: [id])
  blockId String?
  site    Site?   @relation(fields: [siteId], references: [id])
  siteId  String?
  link    Link?   @relation(fields: [linkId], references: [id])
  linkId  String?

  @@index([createdAt])
  @@index([siteId])
  @@index([linkId])
  @@index([blockId])
}

model Link {
  id String @id

  url         String  @db.Text
  name        String? @db.Text
  description String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clicks Click[]
  user   User?   @relation(fields: [userId], references: [id])
  userId String?

  @@index([userId])
  @@index([createdAt])
  @@index([url])
}

model Block {
  id String @id @default(cuid())

  type     String  @db.Text
  position Int     @default(0)
  label    String? @db.Text
  href     String? @db.Text
  logo     String? @db.Text
  style    Json?   @default("{\"hover\": {\"color\": \"#000000\",\"backgroundColor\": \"#ffffff\",\"fontSize\": \"16\",\"fontFamily\": \"Open Sans\"},\"normal\": {\"color\": \"#ffffffe6\",\"backgroundColor\": \"#00000000\",\"fontSize\": \"16\",\"fontFamily\": \"Open Sans\"}}")
  widget   Json?   @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clicks       Click[]
  reservations Reservation[]
  site         Site          @relation(fields: [siteId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  siteId       String

  @@index([siteId])
  @@index([type])
  @@index([position])
  @@index([siteId, type])
}

model Like {
  id String @id @default(cuid())

  ip String

  createdAt DateTime @default(now())

  site   Site    @relation(fields: [siteId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  siteId String
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String?

  @@index([userId])
  @@index([siteId])
  @@index([ip])
  @@index([siteId, ip])
}

model Site {
  id String @id @default(cuid())

  name          String?
  display_name  String?
  description   String? @db.Text
  logo          String? @default("https://qards.link/rsz_noir-fon-transparent.png") @db.Text
  font          String  @default("font-cal")
  image         String? @default("https://qards.link/site-default.png") @db.Text
  imageBlurhash String? @default("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAhCAYAAACbffiEAAAACXBIWXMAABYlAAAWJQFJUiTwAAABfUlEQVR4nN3XyZLDIAwE0Pz/v3q3r55JDlSBplsIEI49h76k4opexCK/juP4eXjOT149f2Tf9ySPgcjCc7kdpBTgDPKByKK2bTPFEdMO0RDrusJ0wLRBGCIuelmWJAjkgPGDSIQEMBDCfA2CEPM80+Qwl0JkNxBimiaYGOTUlXYI60YoehzHJDEm7kxjV3whOQTD3AaCuhGKHoYhyb+CBMwjIAFz647kTqyapdV4enGINuDJMSScPmijSwjCaHeLcT77C7EC0C1ugaCTi2HYfAZANgj6Z9A8xY5eiYghDMNQBJNCWhASot0jGsSCUiHWZcSGQjaWWCDaGMOWnsCcn2QhVkRuxqqNxMSdUSElCDbp1hbNOsa6Ugxh7xXauF4DyM1m5BLtCylBXgaxvPXVwEoOBjeIFVODtW74oj1yBQah3E8tyz3SkpolKS9Geo9YMD1QJR1Go4oJkgO1pgbNZq0AOUPChyjvh7vlXaQa+X1UXwKxgHokB2XPxbX+AnijwIU4ahazAAAAAElFTkSuQmCC") @db.Text
  subdomain     String? @unique
  customDomain  String? @unique
  message404    String? @default("Blimey! You've found a page that doesn't exist.") @db.Text
  background    String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user        User?        @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  userId      String?
  blocks      Block[]
  clicks      Click[]
  subscribers Subscriber[]
  likes       Like[]

  @@index([userId])
  @@index([subdomain])
  @@index([customDomain])
}

model Subscriber {
  id String @id @default(cuid())

  email String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  site   Site   @relation(fields: [siteId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  siteId String

  @@index([siteId])
  @@index([email])
  @@index([siteId, email])
}

model Reservation {
  id String @id @default(cuid())

  name      String?
  email     String
  dateStart DateTime
  dateEnd   DateTime?
  comment   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  block   Block?  @relation(fields: [blockId], references: [id])
  blockId String?

  @@index([dateStart])
  @@index([dateEnd])
  @@index([blockId])
  @@index([email])
  @@index([blockId, email])
}

model Queue {
  id String @id @default(cuid())

  job       String   @default("none")
  payload   Json     @default("{}")
  status    String   @default("pending") @db.VarChar(20)
  attempts  Int      @default(0)
  lastError String?  @db.Text
  runAt     DateTime @default(now()) @db.Timestamptz

  priority            Int       @default(0)
  processingStartedAt DateTime? @db.Timestamptz
  correlationId       String?

  createdAt DateTime @default(now()) @db.Timestamptz
  updatedAt DateTime @updatedAt @db.Timestamptz

  user   User?   @relation("UserQueueJobs", fields: [userId], references: [id], onDelete: Cascade)
  userId String?

  @@index([priority(sort: Desc), status, runAt])
  @@index([status, runAt])
  @@index([correlationId])
  @@index([userId])
  @@index([job])
}

model Action {
  id           String   @id @default(cuid())
  internalName String   @unique
  description  String?
  type         String
  config       Json
  isPublished  Boolean  @default(true)
  version      Int      @default(1)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  rules      Rule[]      @relation("ActionRules")
  executions Execution[] @relation("ActionLogs")
}

model Workflow {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isDefault   Boolean  @default(false)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  rules  Rule[]          @relation("Rules")
  states WorkflowState[] @relation("WorkflowStates")
}

model Trigger {
  id          String  @id @default(cuid())
  code        String  @unique
  description String?

  rules Rule[] @relation("TriggerRules")
}

model Rule {
  id           String  @id @default(cuid())
  workflowId   String
  actionId     String
  triggerId    String
  delayMinutes Int     @default(0)
  order        Int     @default(1)
  isActive     Boolean @default(true)
  version      Int     @default(1)

  ruleConditions RuleCondition[] @relation("RuleConditions")

  workflow   Workflow    @relation("Rules", fields: [workflowId], references: [id], onDelete: Cascade)
  action     Action      @relation("ActionRules", fields: [actionId], references: [id])
  trigger    Trigger     @relation("TriggerRules", fields: [triggerId], references: [id])
  executions Execution[] @relation("RuleActionLogs")

  @@index([workflowId, isActive])
  @@index([triggerId, isActive])
  @@index([actionId])
}

enum ConditionType {
  USER_PROPERTY
  SUBSCRIPTION_STATUS
  EVENT_HISTORY_COUNT
  EVENT_HISTORY_EXISTS
  TRIGGER_PAYLOAD
}

model Condition {
  id          String        @id @default(cuid())
  name        String        @unique
  description String?
  type        ConditionType
  parameters  Json
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  rules RuleCondition[] @relation("ConditionUsage")
}

enum Operator {
  AND
  OR
}

model RuleCondition {
  ruleId      String
  conditionId String
  group       Int      @default(1)
  logic       Operator @default(AND)

  rule      Rule      @relation("RuleConditions", fields: [ruleId], references: [id], onDelete: Cascade)
  condition Condition @relation("ConditionUsage", fields: [conditionId], references: [id], onDelete: Cascade)

  @@id([ruleId, conditionId])
  @@index([conditionId])
}

model Event {
  id            String   @id @default(cuid())
  userId        String
  eventType     String
  payload       Json?
  correlationId String?
  createdAt     DateTime @default(now())
  status        String   @default("pending") @db.VarChar(20)
  attempts      Int      @default(0)
  lastError     String?  @db.Text
  user          User     @relation("UserEvents", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([eventType, createdAt])
  @@index([correlationId])
}

enum WorkflowStateStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

model WorkflowState {
  id         String              @id @default(cuid())
  userId     String
  workflowId String
  status     WorkflowStateStatus @default(ACTIVE)
  startedAt  DateTime            @default(now())
  updatedAt  DateTime            @updatedAt

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  workflow Workflow @relation("WorkflowStates", fields: [workflowId], references: [id], onDelete: Cascade)

  @@unique([userId, workflowId])
  @@index([status])
}

enum ExecutionStatus {
  PENDING
  PROCESSING
  SUCCESS
  FAILED
}

model Execution {
  id            String          @id @default(cuid())
  userId        String
  actionId      String
  ruleId        String?
  executedAt    DateTime?
  status        ExecutionStatus @default(PENDING)
  errorMessage  String?         @db.Text
  resultPayload Json?
  correlationId String?

  user   User   @relation("UserActionLogs", fields: [userId], references: [id], onDelete: Cascade)
  action Action @relation("ActionLogs", fields: [actionId], references: [id])
  rule   Rule?  @relation("RuleActionLogs", fields: [ruleId], references: [id], onDelete: SetNull)

  @@index([userId, executedAt])
  @@index([actionId])
  @@index([status])
  @@index([executedAt])
  @@index([correlationId])
  @@index([ruleId])
}

model Outbox {
  id String @id @default(cuid())

  email    String
  subject  String
  body     String
  status   String @default("pending")
  metadata Json?  @default("{}")

  createdAt DateTime @default(now())

  user User? @relation(fields: [email], references: [email], onDelete: Cascade)

  @@index([createdAt])
  @@index([status])
  @@index([email])
}
